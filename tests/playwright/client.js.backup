const amqplib = require("amqplib");

const RABBITMQ_HOST = process.env.RABBITMQ_HOST || "localhost";
const RABBITMQ_PORT = parseInt(process.env.RABBITMQ_PORT || 5672);
const RABBITMQ_USERNAME = process.env.RABBITMQ_USERNAME || "guest";
const RABBITMQ_PASSWORD = process.env.RABBITMQ_PASSWORD || "guest";
const QUEUE_NAME = process.env.QUEUE_NAME || "queue";

(async () => {
    const connection = await amqplib.connect({
        protocol: "amqp",
        hostname: RABBITMQ_HOST,
        port: RABBITMQ_PORT,
        username: RABBITMQ_USERNAME,
        password: RABBITMQ_PASSWORD,
    });

    const channel = await connection.createChannel();
    await channel.assertQueue(QUEUE_NAME, {
        durable: false
    });

    const msg = {
        "actions": [
            {"action": "page.goto", "args": ["https://www.google.com"]},
            {"action": "page.waitForTimeout", "args": [3000]},
            {"action": "extend.closePages", "args": []},
            {"action": "page.waitForTimeout", "args": [3000]},
            {"action": "page.goto", "args": ["https://www.google.com"]},
            {"action": "page.waitForTimeout", "args": [3000]},
        ],
    };

    channel.sendToQueue(QUEUE_NAME, Buffer.from(JSON.stringify(msg)));
    await channel.close();
    await connection.close();
})();
